<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Use reliable versions and the correct order -->
    <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html,body { margin:0; height:100%; overflow:hidden; }
      #startBtn {
        position: fixed; left:50%; top:50%; transform:translate(-50%,-50%);
        z-index: 10; padding: 12px 18px; font-size: 16px;
      }
      #status {
        position: fixed; left:8px; bottom:8px; z-index: 11;
        padding:6px 10px; background:rgba(0,0,0,.6); color:#fff; font:12px/1.3 monospace;
        border-radius:6px; max-width: 90vw; white-space:pre-wrap;
      }
    </style>
  </head>
  <body>
    <button id="startBtn" disabled>Start AR</button>
    <div id="status">Loadingâ€¦</div>

    <a-scene
      embedded
      mindar-image="imageTargetSrc: ./targets.mind"  <!-- make sure this file exists -->
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <!-- <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" /> -->
        <!-- <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item> -->
        <a-asset-item id="myModel" src="myModel.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <!-- <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane> -->
        <!-- <a-gltf-model rotation="0 0 0 " position="0 0 0.1" scale="0.005 0.005 0.005" src="#avatarModel" animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"> -->
        <a-gltf-model
          src="#myModel"
          scale="0.30 0.30 0.30"
          position="0 0 0"
          rotation="90 0 0">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const statusEl = document.getElementById('status');
      const startBtn = document.getElementById('startBtn');
      const sceneEl = document.querySelector('a-scene');

      function log(msg) { console.log(msg); statusEl.textContent = String(msg); }

      // 1) Verify A-Frame + MindAR adapter actually registered the system
      sceneEl.addEventListener('loaded', () => {
        const systems = Object.keys(sceneEl.systems || {});
        console.log('A-Frame systems:', systems);
        if (!sceneEl.systems['mindar-image-system']) {
          log('MindAR A-Frame adapter did not register.\nCheck script order/URLs.');
          startBtn.disabled = true;
          return;
        }
        log('MindAR system detected. Ready to start.');
        startBtn.disabled = false;
      });

      // 2) MindAR lifecycle diagnostics (fires after arSystem.start())
      sceneEl.addEventListener('arReady', () => log('arReady: camera + tracker started.'));
      sceneEl.addEventListener('arError', (e) => log('arError: ' + (e?.detail || 'unknown')));

      // 3) Start on user gesture (needed on iOS)
      startBtn.addEventListener('click', async () => {
        try {
          // Hint iOS to show the prompt early
          const tmp = await navigator.mediaDevices.getUserMedia({ video: true });
          tmp.getTracks().forEach(t => t.stop());

          const arSystem = sceneEl.systems['mindar-image-system'];
          await arSystem.start();
          startBtn.style.display = 'none';
        } catch (err) {
          console.error(err);
          log('Camera permission denied or not available:\n' + err);
        }
      });
    </script>
  </body>
</html>
